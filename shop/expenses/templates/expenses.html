{% extends 'base.html' %}
{% block title %}Expenses - My Finance App{% endblock %}
{% block content %}
{% load static %}
<style>
   h2 {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

.form-box {
      background: #6b383800;
      border-radius: 10px;
      padding: 20px;
      max-width: 950px;
      margin: auto;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.6s ease forwards;
    }
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
input,
    button {
      padding: 10px;
      margin: 10px 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    #mode {
      padding: 10px;
      margin: 10px 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      background: #3f5efb;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #324bce;
    }

    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
    }

    th {
      padding: 15px;
      border: 1px solid #5a111177;
      font-size: 20px;
      background: #98baed8d;
      gap: 0px;
      text-align: center;
    }

    td {
      padding: 0px;
      border: 1px solid #5a111177;
      gap: 0px;
      text-align: center;
    }

    
    .search {
      display: flex;
      position: relative;
      top: 30px;
      left: 50%;
      right: 0;
      transform: translate(-50%, -50%);
      transition: all 1s;
      width: 50px;
      height: 50px;
      background: rgba(250, 4, 221, 0);
      box-sizing: border-box;
      border-radius: 25px;
      border: 1px solid rgba(4, 0, 4, 0);
      padding: 5px;
    }
.search input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 42.5px;
      line-height: 30px;
      outline: 2px;
      border: 2px solid black;
      display: none;
      font-size: 1em;
      border-radius: 15px;
      padding: 0 20px;
    }

    .search.fa {
      box-sizing: border-box;
      padding: 10px;
      width: 42.5px;
      height: 42.5px;
      position: absolute;
      top: 0;
      right: 0;
      border-radius: 50%;
      color: #8c52ff;
      text-align: center;
      font-size: 1.2em;
      transition: all 1s;
    }

    .search:hover {
      width: 300px;
      cursor: pointer;
    }

    .search:hover input {
      display: block;
    }

    .search:hover .fa {
      background: #8c52ff00;
      color: rgb(241, 9, 9);
    }

    .search.center {
      display: flex;
      position: relative;

    }
.actions button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      transition: background-color 0.3s ease;
    }

    .edit-btn {
      background-color: #28a74600;
      /* green */
    }

    .edit-btn:hover {
      background-color: #21883700;
    }

    .delete-btn {
      background-color: #dc354600;
      /* red */
      margin-left: 8px;
    }

    .delete-btn:hover {
      background-color: #c8233300;
    }

    .total {
      text-align: right;
      margin-top: 15px;
      font-weight: bold;
      color: #ffffff;
      font-size: 18px;
    }


#expenseTableBody{
      background-color: #c0c0c000;
      font-size: 20px;
      text-align: center;
      border-radius: 10px;
      padding: 20px;
      margin: auto;
      animation: slideIn 0.6s ease forwards;
}

.export{
    margin: 20px 0;
margin-left: 23rem;
  }

  a.nav-link {
      color: rgb(10, 0, 0);
      text-decoration: none;
      margin: 0 12px;
      font-weight: bold;
      font-size: 30px;
      font-family: "Tangerine", cursive;
    }
</style>
<h2>Expense Tracker</h2>

<div class="form-box">
  <form id="expenseForm">
    {% csrf_token %}
    <input type="date" id="date" required />
    <input type="text" id="description" placeholder="Description" required />
    <select id="mode" required>
      <option value="" disabled selected>Select mode</option>
      <option value="cash">Cash</option>
      <option value="icici">ICICI</option>
      <option value="d_cash">D_Cash</option>
      <option value="idfc">IDFC</option>
      <option value="sbi">SBI</option>
      <option value="alpha">Alpha</option>
      <option value="hdfc">HDFC</option>
    </select>
    <input type="number" step="0.01" id="amount" placeholder="Amount â‚¹" required />
    <button type="submit" id="addBtn">Add Expense</button>
  </form>

  <div class="search center" id="searchInput">
    <input type="search" placeholder="Search here ...">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z"/></svg>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Description</th><th>Mode</th><th>Amount (â‚¹)</th><th>Actions</th>
        
      </tr>
    </thead>
    <tbody id="expenseTableBody"></tbody>
    
  </table>
  <div id="pagination" style="text-align:center; margin-top:15px;">page</div>
  <div class="total" id="totalExpense">Total: â‚¹0</div>
  <div class="export">
  <a href="{% url 'expenses:export_expenses_excel' %}" class="btn btn-success"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16">
  <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
  <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
</svg>  Excel</a>
  <a href="{% url 'expenses:export_expenses_pdf' %}" class="btn btn-danger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-pdf" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM1.6 11.85H0v3.999h.791v-1.342h.803q.43 0 .732-.173.305-.175.463-.474a1.4 1.4 0 0 0 .161-.677q0-.375-.158-.677a1.2 1.2 0 0 0-.46-.477q-.3-.18-.732-.179m.545 1.333a.8.8 0 0 1-.085.38.57.57 0 0 1-.238.241.8.8 0 0 1-.375.082H.788V12.48h.66q.327 0 .512.181.185.183.185.522m1.217-1.333v3.999h1.46q.602 0 .998-.237a1.45 1.45 0 0 0 .595-.689q.196-.45.196-1.084 0-.63-.196-1.075a1.43 1.43 0 0 0-.589-.68q-.396-.234-1.005-.234zm.791.645h.563q.371 0 .609.152a.9.9 0 0 1 .354.454q.118.302.118.753a2.3 2.3 0 0 1-.068.592 1.1 1.1 0 0 1-.196.422.8.8 0 0 1-.334.252 1.3 1.3 0 0 1-.483.082h-.563zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638z"/>
</svg>  PDF</a>
</div>
</div>


<script>

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // API endpoints (match your expenses/urls.py namespaced routes)
  const API_LIST   = "{% url 'expenses:api_list' %}";
  const API_ADD    = "{% url 'expenses:api_add' %}";
  const API_UPDATE = "{% url 'expenses:api_update' %}";
  const API_DELETE = "{% url 'expenses:api_delete' %}";

  // DOM refs
  const form = document.getElementById("expenseForm");
  const tableBody = document.getElementById("expenseTableBody");
  const totalDisplay = document.getElementById("totalExpense");
  const addBtn = document.getElementById("addBtn");
  const paginationContainer = document.getElementById("pagination");
  const searchInputEl = document.querySelector("#searchInput input");

  let editingId = null;
  let expensesData = [];   // full dataset
  let currentPage = 1;
  const rowsPerPage = 5;

  // utils
  function formatDMY(isoDate) {
    if (!isoDate) return '';
    const d = new Date(isoDate);
    if (isNaN(d)) return isoDate;
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  }
  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  // FETCH and render first page
  async function fetchAndRenderExpenses() {
    try {
      const res = await fetch(API_LIST);
      if (!res.ok) throw new Error('Failed to fetch list');
      expensesData = await res.json();
      currentPage = 1;
      renderTableExpenses();
    } catch (e) {
      console.error(e);
      tableBody.innerHTML = "<tr><td colspan='5'>Error loading expenses.</td></tr>";
      totalDisplay.textContent = "Total: â‚¹0";
    }
  }

  // RENDER table (respects search + pagination)
  function renderTableExpenses() {
    const query = (searchInputEl && searchInputEl.value) ? searchInputEl.value.trim().toLowerCase() : '';

    // filter
    const filtered = expensesData.filter(item => {
      const text = `${item.date} ${item.description} ${item.mode} ${item.amount}`.toLowerCase();
      return text.includes(query);
    });

    // totals
    const total = filtered.reduce((acc, cur) => acc + parseFloat(cur.amount || 0), 0);

    // pagination window
    const totalPages = Math.max(1, Math.ceil(filtered.length / rowsPerPage));
    if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * rowsPerPage;
    const paginated = filtered.slice(start, start + rowsPerPage);

    // rows
    tableBody.innerHTML = '';
    if (paginated.length === 0) {
      tableBody.innerHTML = "<tr><td colspan='5'>No expenses found.</td></tr>";
    } else {
      for (const item of paginated) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDMY(item.date)}</td>
          <td>${escapeHtml(item.description)}</td>
          <td>${escapeHtml(item.mode)}</td>
          <td>â‚¹${Number(item.amount).toFixed(2)}</td>
          <td class="actions"></td>
        `;

        // actions
        const actionsCell = tr.querySelector('.actions');

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.type = 'button';
        editBtn.title = 'Edit';
        editBtn.innerText = 'âœï¸';
        editBtn.addEventListener('click', () => startEditExpense(item.id, item.date, item.description, item.mode, item.amount));
        actionsCell.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.type = 'button';
        delBtn.title = 'Delete';
        delBtn.innerText = 'ðŸ—‘ï¸';
        delBtn.style.marginLeft = '8px';
        delBtn.addEventListener('click', () => deleteExpense(item.id));
        actionsCell.appendChild(delBtn);

        tableBody.appendChild(tr);
      }
    }

    totalDisplay.textContent = `Total: â‚¹${total.toFixed(2)}`;
    renderPaginationExpenses(filtered.length, totalPages);
  }

  // pagination controls
  function renderPaginationExpenses(filteredLength, totalPages) {
    if (!paginationContainer) return;
    paginationContainer.innerHTML = '';

    if (filteredLength <= rowsPerPage) return; // nothing to paginate

    // Prev
    const prev = document.createElement('button');
    prev.type = 'button';
    prev.disabled = (currentPage === 1);
    prev.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-240 200-480l240-240 56 56-183 184 183 184-56 56Zm264 0L464-480l240-240 56 56-183 184 183 184-56 56Z"/></svg>';
    prev.addEventListener('click', () => changePageExpenses(currentPage - 1));
    paginationContainer.appendChild(prev);

    // page numbers (max 7 buttons)
    const maxButtons = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    let endPage = startPage + maxButtons - 1;
    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = Math.max(1, endPage - maxButtons + 1);
    }
    for (let i = startPage; i <= endPage; i++) {
      const pbtn = document.createElement('button');
      pbtn.type = 'button';
      pbtn.innerText = i;
      if (i === currentPage) {
        pbtn.style.background = 'white';
        pbtn.style.color = 'red';
      }
      pbtn.addEventListener('click', () => changePageExpenses(i));
      paginationContainer.appendChild(pbtn);
    }

    // Next
    const next = document.createElement('button');
    next.type = 'button';
    next.disabled = (currentPage === totalPages);
    next.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M383-480 200-664l56-56 240 240-240 240-56-56 183-184Zm264 0L464-664l56-56 240 240-240 240-56-56 183-184Z"/></svg>';
    next.addEventListener('click', () => changePageExpenses(currentPage + 1));
    paginationContainer.appendChild(next);
  }

  function changePageExpenses(page) {
    if (page < 1) return;
    currentPage = page;
    renderTableExpenses();
  }

  // start edit -> populate form
  function startEditExpense(id, date, description, mode, amount) {
    document.getElementById('date').value = date;
    document.getElementById('description').value = description;
    document.getElementById('mode').value = mode;
    document.getElementById('amount').value = amount;
    editingId = id;
    addBtn.textContent = 'Update Expense';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // delete
  async function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    try {
      const res = await fetch(API_DELETE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ id })
      });
      const out = await res.json();
      if (out.status === 'success') {
        expensesData = expensesData.filter(x => x.id !== id);
        renderTableExpenses();
      } else {
        alert('Delete failed: ' + (out.message || 'unknown'));
      }
    } catch (err) {
      console.error('deleteExpense error:', err);
      alert('Delete failed (network/server error).');
    }
  }

  // submit -> add or update
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      date: document.getElementById('date').value,
      description: document.getElementById('description').value.trim(),
      mode: document.getElementById('mode').value,
      amount: parseFloat(document.getElementById('amount').value),
    };

    if (!payload.date || !payload.description || !payload.mode || isNaN(payload.amount)) {
      alert('Please fill all fields correctly.');
      return;
    }

    try {
      if (editingId) {
        payload.id = editingId;
        const res = await fetch(API_UPDATE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        });
        const out = await res.json();
        if (out.status === 'success') {
          const idx = expensesData.findIndex(x => x.id === editingId);
          if (idx > -1) expensesData[idx] = { ...expensesData[idx], ...payload, amount: payload.amount };
          editingId = null;
          addBtn.textContent = 'Add Expense';
          form.reset();
          renderTableExpenses();
        } else {
          alert('Update failed: ' + (out.message || 'unknown'));
        }
      } else {
        const res = await fetch(API_ADD, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        });
        const out = await res.json();
        if (out.status === 'success') {
          if (out.item) {
            expensesData.unshift(out.item);
          } else if (out.id) {
            expensesData.unshift({ id: out.id, ...payload });
          } else {
            await fetchAndRenderExpenses(); // fallback
            form.reset();
            return;
          }
          form.reset();
          currentPage = 1;
          renderTableExpenses();
        } else {
          alert('Add failed: ' + (out.message || 'unknown'));
        }
      }
    } catch (err) {
      console.error('submit error:', err);
      alert('Request failed (network/server error).');
    }
  });

  // live search hooks into pagination
  if (searchInputEl) {
    searchInputEl.addEventListener('input', () => {
      currentPage = 1;
      renderTableExpenses();
    });
  }

  // initial load
  window.addEventListener('DOMContentLoaded', fetchAndRenderExpenses);
</script>


{% endblock %}